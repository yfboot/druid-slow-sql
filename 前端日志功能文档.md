# å‰ç«¯æ—¥å¿—åŠŸèƒ½æ–‡æ¡£

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å‰ç«¯æ—¥å¿—åŠŸèƒ½æ”¯æŒé€šè¿‡REST APIæ¥å£æ”¶é›†å‰ç«¯æ—¥å¿—å¹¶å­˜å‚¨åˆ°æ–‡ä»¶ç³»ç»Ÿï¼Œæä¾›å®Œæ•´çš„æ—¥å¿—ç®¡ç†å’ŒæŸ¥è¯¢åŠŸèƒ½ã€‚

### æ ¸å¿ƒåŠŸèƒ½
- **å¤šç§æ—¥å¿—è®°å½•æ–¹å¼** - å•æ¡ã€æ‰¹é‡ã€å¿«é€Ÿè®°å½•
- **æ—¥å¿—æ–‡ä»¶ç®¡ç†** - è‡ªåŠ¨æ»šåŠ¨ã€å‹ç¼©å½’æ¡£ã€å¤§å°æ§åˆ¶
- **å†…å®¹éªŒè¯** - é˜²æ­¢æ¶æ„æˆ–å¼‚å¸¸å¤§å°çš„è¯·æ±‚
- **å¤§å®¹é‡æ”¯æŒ** - å•æ¬¡è¯·æ±‚æœ€å¤§20MBï¼Œæ”¯æŒå¤§é‡æ—¥å¿—æ•°æ®
- **å¼‚æ­¥å¤„ç†** - åå°å¼‚æ­¥å†™å…¥ï¼Œä¸å½±å“å“åº”æ€§èƒ½

## ğŸ“‚ æ—¥å¿—æ–‡ä»¶ç»“æ„

```
logs/
â”œâ”€â”€ frontend/                                    # å‰ç«¯æ—¥å¿—ç›®å½•
â”‚   â”œâ”€â”€ druid-slow-sql-frontend.log             # å½“å‰æ—¥å¿—æ–‡ä»¶ï¼ˆ25MBï¼‰
â”‚   â””â”€â”€ archive/                                 # å½’æ¡£ç›®å½•
â”‚       â”œâ”€â”€ druid-slow-sql-frontend-2024-01-20-1.log.gz
â”‚       â””â”€â”€ druid-slow-sql-frontend-2024-01-19-1.log.gz
```

### æ–‡ä»¶ç®¡ç†ç­–ç•¥
- **å•æ–‡ä»¶å¤§å°**: 25MBï¼ˆè¾¾åˆ°åè‡ªåŠ¨æ»šåŠ¨ï¼‰
- **ä¿ç•™å¤©æ•°**: 30å¤©
- **å‹ç¼©æ–¹å¼**: gzipå‹ç¼©å½’æ¡£
- **å¯åŠ¨è¡Œä¸º**: ç³»ç»Ÿå¯åŠ¨æ—¶æ¸…ç©ºå½“å‰æ—¥å¿—æ–‡ä»¶
- **å‘½åè§„èŒƒ**: `druid-slow-sql-frontend-{æ—¥æœŸ}-{åºå·}.log.gz`

## ğŸŒ APIæ¥å£

### åŸºç¡€URL: `/api/frontend-log`

| æ¥å£ | æ–¹æ³• | åŠŸèƒ½è¯´æ˜ | å‚æ•°è¯´æ˜ |
|------|------|----------|----------|
| `/single` | POST | è®°å½•å•æ¡æ—¥å¿— | JSONå¯¹è±¡ï¼ŒåŒ…å«å®Œæ•´æ—¥å¿—ä¿¡æ¯ |
| `/batch` | POST | æ‰¹é‡è®°å½•æ—¥å¿— | JSONæ•°ç»„ï¼Œæœ€å¤š100æ¡æ—¥å¿— |
| `/quick` | POST | å¿«é€Ÿè®°å½•æ—¥å¿— | URLå‚æ•°æ–¹å¼ï¼Œé€‚åˆç®€å•åœºæ™¯ |
| `/config` | GET | è·å–é…ç½®ä¿¡æ¯ | è¿”å›æ”¯æŒçš„æ—¥å¿—çº§åˆ«ã€é™åˆ¶ç­‰ |
| `/info` | GET | è·å–æ—¥å¿—æ–‡ä»¶ä¿¡æ¯ | æ–‡ä»¶å¤§å°ã€ä¿®æ”¹æ—¶é—´ã€æ—¥å¿—æ¡æ•° |
| `/recent` | GET | è·å–æœ€è¿‘æ—¥å¿—å†…å®¹ | `?lines=50` è¿”å›æœ€è¿‘Nè¡Œ |
| `/init` | POST | åˆå§‹åŒ–æ—¥å¿—ç›®å½• | åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ |

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### 1. å•æ¡æ—¥å¿—è®°å½•

```javascript
// æ—¥æœŸæ ¼å¼åŒ–å‡½æ•°
function formatDateTime(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const seconds = String(date.getSeconds()).padStart(2, '0');
    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
}

// å•æ¡æ—¥å¿—è®°å½•
const logData = {
    level: "ERROR",                              // æ—¥å¿—çº§åˆ«
    message: "JavaScriptè¿è¡Œæ—¶é”™è¯¯",             // æ—¥å¿—æ¶ˆæ¯
    module: "UserModule",                        // æ¨¡å—åç§°
    userId: "user123",                           // ç”¨æˆ·ID
    url: window.location.href,                   // é¡µé¢URL
    userAgent: navigator.userAgent,              // æµè§ˆå™¨ä¿¡æ¯
    metadata: JSON.stringify({                   // å…ƒæ•°æ®
        sessionId: "abc123",
        ip: "192.168.1.100"
    }),
    stack: error.stack,                          // é”™è¯¯å †æ ˆ
    timestamp: formatDateTime(new Date())        // æ—¶é—´æˆ³
};

fetch('/api/frontend-log/single', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(logData)
})
.then(response => response.json())
.then(result => console.log('æ—¥å¿—è®°å½•æˆåŠŸ:', result));
```

### 2. æ‰¹é‡æ—¥å¿—è®°å½•

```javascript
const batchLogs = [
    {
        level: "INFO",
        message: "é¡µé¢åŠ è½½å®Œæˆ",
        module: "PageModule",
        userId: "user123",
        timestamp: formatDateTime(new Date())
    },
    {
        level: "WARN",
        message: "ç½‘ç»œè¯·æ±‚ç¼“æ…¢",
        module: "NetworkModule", 
        userId: "user123",
        timestamp: formatDateTime(new Date())
    }
];

fetch('/api/frontend-log/batch', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(batchLogs)
})
.then(response => response.json())
.then(result => console.log('æ‰¹é‡æ—¥å¿—è®°å½•æˆåŠŸ:', result));
```

### 3. å¿«é€Ÿæ—¥å¿—è®°å½•

```javascript
// é€‚åˆç®€å•åœºæ™¯çš„å¿«é€Ÿè®°å½•
fetch('/api/frontend-log/quick?level=ERROR&message=' + 
      encodeURIComponent('è¯·æ±‚å¤±è´¥') + 
      '&module=ApiModule&userId=user123', {
    method: 'POST'
})
.then(response => response.json())
.then(result => console.log('å¿«é€Ÿæ—¥å¿—è®°å½•æˆåŠŸ:', result));
```

## ğŸ“ å†…å®¹é™åˆ¶å’Œå®¹é‡

### å•ä¸ªå­—æ®µé™åˆ¶
| å­—æ®µ | æœ€å¤§å¤§å° | è¯´æ˜ |
|------|----------|------|
| æ¶ˆæ¯å†…å®¹ | 10KB | æ—¥å¿—æ¶ˆæ¯ä¸»ä½“ |
| é”™è¯¯å †æ ˆ | 50KB | JavaScripté”™è¯¯å †æ ˆ |
| å…ƒæ•°æ® | 5KB | JSONæ ¼å¼çš„é¢å¤–æ•°æ® |
| URLåœ°å€ | 2KB | é¡µé¢URL |

### æ‰¹é‡è¯·æ±‚é™åˆ¶
- **æœ€å¤§æ¡æ•°**: 100æ¡æ—¥å¿—/æ¬¡
- **è¯·æ±‚ä½“å¤§å°**: 20MB/æ¬¡
- **å¹¶å‘è¿æ¥**: æ”¯æŒå¤šä¸ªå¹¶å‘è¯·æ±‚

### å®¹é‡è®¡ç®—ç¤ºä¾‹
```
ç®€å•æ—¥å¿—ï¼ˆçº¦300å­—èŠ‚/æ¡ï¼‰: å•æ¬¡å¯æäº¤ ~66,000æ¡
åŒ…å«å †æ ˆçš„é”™è¯¯æ—¥å¿—ï¼ˆçº¦50KB/æ¡ï¼‰: å•æ¬¡å¯æäº¤ ~400æ¡
æ··åˆç±»å‹æ—¥å¿—: å•æ¬¡å¯æäº¤ ~1,000-5,000æ¡
```

## ğŸ”„ é«˜çº§ç”¨æ³•

### 1. åˆ†æ‰¹æäº¤å¤„ç†

```javascript
// å¤„ç†å¤§é‡æ—¥å¿—çš„åˆ†æ‰¹æäº¤
function submitLogsInBatches(logs, batchSize = 50) {
    const batches = [];
    for (let i = 0; i < logs.length; i += batchSize) {
        batches.push(logs.slice(i, i + batchSize));
    }
    
    return Promise.all(
        batches.map(batch => 
            fetch('/api/frontend-log/batch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(batch)
            })
        )
    );
}

// ä½¿ç”¨ç¤ºä¾‹
submitLogsInBatches(largeLogArray, 50);
```

### 2. å¼‚æ­¥é˜Ÿåˆ—ç®¡ç†

```javascript
// å‰ç«¯æ—¥å¿—é˜Ÿåˆ—ç®¡ç†
class LogQueue {
    constructor() {
        this.queue = [];
        this.isProcessing = false;
        this.maxQueueSize = 1000;
    }
    
    add(log) {
        if (this.queue.length >= this.maxQueueSize) {
            this.queue.shift(); // ç§»é™¤æœ€æ—§æ—¥å¿—
        }
        this.queue.push(log);
        this.processQueue();
    }
    
    async processQueue() {
        if (this.isProcessing || this.queue.length === 0) return;
        
        this.isProcessing = true;
        const batch = this.queue.splice(0, 50);
        
        try {
            await fetch('/api/frontend-log/batch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(batch)
            });
        } catch (error) {
            console.warn('æ—¥å¿—æäº¤å¤±è´¥:', error);
        }
        
        this.isProcessing = false;
        
        if (this.queue.length > 0) {
            setTimeout(() => this.processQueue(), 1000);
        }
    }
}

// å…¨å±€æ—¥å¿—é˜Ÿåˆ—ä½¿ç”¨
const globalLogQueue = new LogQueue();
globalLogQueue.add({ level: 'INFO', message: 'ç”¨æˆ·æ“ä½œ' });
```

### 3. é”™è¯¯å¤„ç†å’Œé‡è¯•

```javascript
// å¸¦è¶…æ—¶å’Œé‡è¯•çš„æ—¥å¿—æäº¤
async function submitWithRetry(logs, maxRetries = 3, timeout = 10000) {
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);
            
            const response = await fetch('/api/frontend-log/batch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(logs),
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            return response;
            
        } catch (error) {
            console.warn(`æ—¥å¿—æäº¤å¤±è´¥ (å°è¯• ${attempt}/${maxRetries}):`, error);
            
            if (attempt === maxRetries) {
                // æœ€åä¸€æ¬¡å¤±è´¥ï¼Œç¼“å­˜åˆ°æœ¬åœ°
                localStorage.setItem('pendingLogs', 
                    JSON.stringify(logs));
            } else {
                // ç­‰å¾…åé‡è¯•
                await new Promise(resolve => 
                    setTimeout(resolve, 1000 * attempt));
            }
        }
    }
}
```

### 4. æœ¬åœ°ç¼“å­˜å¤‡ä»½

```javascript
// æœ¬åœ°å­˜å‚¨ç®¡ç†
class LocalLogCache {
    static save(logs) {
        const cached = JSON.parse(localStorage.getItem('pendingLogs') || '[]');
        cached.push(...logs);
        
        // é™åˆ¶ç¼“å­˜å¤§å°ï¼Œé˜²æ­¢å­˜å‚¨æº¢å‡º
        if (cached.length > 5000) {
            cached.splice(0, cached.length - 5000);
        }
        
        localStorage.setItem('pendingLogs', JSON.stringify(cached));
    }
    
    static getAndClear() {
        const logs = JSON.parse(localStorage.getItem('pendingLogs') || '[]');
        localStorage.removeItem('pendingLogs');
        return logs;
    }
    
    static retrySubmit() {
        const cachedLogs = this.getAndClear();
        if (cachedLogs.length > 0) {
            return submitLogsInBatches(cachedLogs);
        }
    }
}
```

## ğŸ¯ å®é™…åº”ç”¨åœºæ™¯

### 1. ç”¨æˆ·è¡Œä¸ºè·Ÿè¸ª

```javascript
// ç”¨æˆ·ç‚¹å‡»è·Ÿè¸ª
document.addEventListener('click', function(event) {
    globalLogQueue.add({
        level: 'INFO',
        message: `ç”¨æˆ·ç‚¹å‡»: ${event.target.tagName}`,
        module: 'UserBehavior',
        userId: getCurrentUserId()
    });
});

// é¡µé¢è·¯ç”±å˜åŒ–
window.addEventListener('hashchange', function() {
    globalLogQueue.add({
        level: 'INFO',
        message: `è·¯ç”±å˜åŒ–: ${window.location.hash}`,
        module: 'Router',
        userId: getCurrentUserId()
    });
});
```

### 2. é”™è¯¯ç›‘æ§

```javascript
// å…¨å±€é”™è¯¯æ•è·
window.addEventListener('error', function(event) {
    globalLogQueue.add({
        level: 'ERROR',
        message: event.message,
        module: 'GlobalError',
        stack: event.error ? event.error.stack : '',
        url: event.filename,
        metadata: JSON.stringify({
            line: event.lineno,
            column: event.colno
        })
    });
});

// Promiseé”™è¯¯æ•è·
window.addEventListener('unhandledrejection', function(event) {
    globalLogQueue.add({
        level: 'ERROR',
        message: `Promise rejection: ${event.reason}`,
        module: 'PromiseError',
        stack: event.reason.stack || ''
    });
});
```

### 3. æ€§èƒ½ç›‘æ§

```javascript
// é¡µé¢åŠ è½½æ€§èƒ½
window.addEventListener('load', function() {
    const navigation = performance.getEntriesByType('navigation')[0];
    globalLogQueue.add({
        level: 'INFO',
        message: 'é¡µé¢åŠ è½½å®Œæˆ',
        module: 'Performance',
        metadata: JSON.stringify({
            loadTime: navigation.loadEventEnd - navigation.fetchStart,
            domReady: navigation.domContentLoadedEventEnd - navigation.fetchStart
        })
    });
});
```

## âš™ï¸ é…ç½®è¯´æ˜

### application.ymlé…ç½®
```yaml
# å‰ç«¯æ—¥å¿—é…ç½®
frontend:
  log:
    enabled: true                      # å¯ç”¨å‰ç«¯æ—¥å¿—åŠŸèƒ½
    max-batch-size: 100               # æ‰¹é‡æ—¥å¿—æœ€å¤§æ•°é‡
    level-mapping:                     # æ—¥å¿—çº§åˆ«æ˜ å°„
      debug: DEBUG
      info: INFO
      warn: WARN
      error: ERROR

# æœåŠ¡å™¨é…ç½®
server:
  tomcat:
    max-http-post-size: 20MB          # æ”¯æŒå¤§é‡æ—¥å¿—æ•°æ®

# HTTPè¯·æ±‚é™åˆ¶
spring:
  servlet:
    multipart:
      max-file-size: 20MB
      max-request-size: 20MB
```

### ç¯å¢ƒå£°æ˜é…ç½®
```yaml
# ç¯å¢ƒå£°æ˜ï¼ˆä¸æ¿€æ´»Profileï¼‰
app:
  environment: dev  # å¯é€‰å€¼ï¼šdev, test, prod
```

## ğŸ“Š ç›‘æ§å’ŒæŸ¥è¯¢

### æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ä¿¡æ¯
```bash
curl http://localhost:8080/api/frontend-log/info
```

### è·å–æœ€è¿‘æ—¥å¿—å†…å®¹
```bash
curl http://localhost:8080/api/frontend-log/recent?lines=100
```

### æŸ¥çœ‹ç³»ç»Ÿé…ç½®
```bash
curl http://localhost:8080/api/frontend-log/config
```

## ğŸ”§ æµ‹è¯•é¡µé¢

è®¿é—® http://localhost:8080/frontend-log-test.html è¿›è¡Œå¯è§†åŒ–æµ‹è¯•ï¼š
- å•æ¡æ—¥å¿—è®°å½•è¡¨å•
- æ‰¹é‡æ—¥å¿—ç”Ÿæˆå’Œæäº¤
- å¿«é€Ÿæ—¥å¿—è®°å½•æŒ‰é’®
- é…ç½®ä¿¡æ¯æŸ¥çœ‹
- æ—¥å¿—æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤º

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ—¶é—´æ ¼å¼**: å¿…é¡»ä½¿ç”¨ `yyyy-MM-dd HH:mm:ss` æ ¼å¼ï¼Œä¸æ”¯æŒISO 8601æ ¼å¼
2. **å­—æ®µéªŒè¯**: è¶…å‡ºå¤§å°é™åˆ¶çš„è¯·æ±‚ä¼šè¢«æ‹’ç»å¹¶è¿”å›400é”™è¯¯
3. **å¼‚æ­¥å¤„ç†**: æ—¥å¿—å†™å…¥æ˜¯å¼‚æ­¥çš„ï¼Œè¿”å›æˆåŠŸä¸ä»£è¡¨ç«‹å³å†™å…¥æ–‡ä»¶
4. **ç£ç›˜ç©ºé—´**: éœ€è¦ç›‘æ§æ—¥å¿—ç›®å½•çš„ç£ç›˜ä½¿ç”¨æƒ…å†µ
5. **ç½‘ç»œå¼‚å¸¸**: å»ºè®®å®ç°æœ¬åœ°ç¼“å­˜æœºåˆ¶å¤„ç†ç½‘ç»œä¸­æ–­æƒ…å†µ 